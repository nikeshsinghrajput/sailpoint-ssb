<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE Rule PUBLIC "sailpoint.dtd" "sailpoint.dtd">
<Rule language="beanshell" name="NS_Rule_MailBoxProvisioning">
  <Description>
    Create Mail for Active Directory
  </Description>
  <Source>

  import org.apache.log4j.Logger;
  import sailpoint.api.IdentityService;
  import sailpoint.api.Provisioner;
  import sailpoint.api.SailPointContext;
  import sailpoint.object.Application;
  import sailpoint.object.Custom;
  import sailpoint.object.Filter;
  import sailpoint.object.Identity;
  import sailpoint.object.Link;
  import sailpoint.object.ProvisioningPlan;
  import sailpoint.object.ProvisioningPlan.AccountRequest;
  import sailpoint.object.ProvisioningPlan.AttributeRequest;
  import sailpoint.object.ProvisioningProject;
  import sailpoint.object.QueryOptions;
  import sailpoint.object.TaskDefinition;
  import sailpoint.tools.GeneralException;
  import sailpoint.tools.Util;



  Logger logger = Logger.getLogger("com.ns.rule.NS_Rule_MailBoxProvisioning");
  String identityName=null;
  String ADAppName=null;
  String ADMailDomain=null;
  Application adApp=null;
  Identity identity=null;
  try {
    TaskDefinition taskDef = context.getObjectByName(TaskDefinition.class,"NS-TaskDefination-MailBoxProvisioning"); 
    identityName = taskDef.getString("identityName");


    System.out.println("identityName:::"+identityName);

    if (Util.isNotNullOrEmpty(identityName)) {
      identityName=identityName.trim();
      Custom custom =context.getObjectByName(Custom.class,"NS_CustomObject_Active_Directory");
      if(custom!=null){
        ADAppName=custom.get("AdAppName");
        ADMailDomain=custom.get("ADMailDomain");
        if(Util.isNotNullOrEmpty(ADAppName) &amp;&amp; Util.isNotNullOrEmpty(ADMailDomain)){
          adApp=context.getObjectByName(Application.class,ADAppName);
        }				 
      }
      System.out.println("ADAppName:::::"+ADAppName);
      System.out.println("ADMailDomain:::::"+ADMailDomain);
      Filter filter=Filter.and(Filter.eq("name",identityName),Filter.eq("inactive",false));
      QueryOptions queryOption=new QueryOptions();
      queryOption.addFilter(filter);
      List identityList=context.getObjects(Identity.class, queryOption);
      if(identityList!=null &amp;&amp; identityList.size()&gt;0) {
        identity=identityList.get(0);
         System.out.println("identity disolay name:::::"+identity.getDisplayName());
      }                
      if (identity != null &amp;&amp; adApp!=null) {
        IdentityService is=new IdentityService(context);
        List ADLinks =is.getLinks(identity, adApp);
        if(ADLinks!=null &amp;&amp; ADLinks.size()&gt;0){
          for(Link ADLink:ADLinks){
            String email=ADLink.getAttribute("mail");
            System.out.println("checking identity email:::::"+email);
            if(Util.isNullOrEmpty(email)){
              String samAccountName=ADLink.getAttribute("sAMAccountName");
              System.out.println("identity samAccountName:::::"+samAccountName);
              email=samAccountName+ADMailDomain;
              ProvisioningPlan plan=new ProvisioningPlan();
              AccountRequest acr=new AccountRequest();
              List abrlList=new ArrayList();
              acr.setNativeIdentity(ADLink.getNativeIdentity());
              acr.setApplication(ADAppName);
              acr.setOperation(AccountRequest.Operation.Modify);
              abrlList.add(new AttributeRequest("mail",ProvisioningPlan.Operation.Set,email));
              acr.setAttributeRequests(abrlList);
              plan.add(acr);
              plan.setIdentity(identity);
              System.out.println("plan:::::"+plan.toXml());
              Provisioner provisioner=new Provisioner(context);
              ProvisioningProject provisioningProject=provisioner.compile(plan);
              provisioner.execute(provisioningProject);
              System.out.println("MailBoxProvisioning done");
              taskResult.setAttribute("responseCode", "200");
              taskResult.setAttribute("message",email+" created in AD");
            }
          }
        }

      }else{
        taskResult.setAttribute("responseCode", "400");
        taskResult.setAttribute("message","Account Or Identity Getting Error");
      }
    }else{
      taskResult.setAttribute("responseCode", "400");
      taskResult.setAttribute("message","IdentityName must be pass");
    }
  } catch (Exception ex) {
    taskResult.setAttribute("responseCode", "400");
    taskResult.setAttribute("message","Provisioning Error");
    System.out.println("Error in NS_Rule_Change_Hr_App_Status: ", ex);
  }

  </Source>
</Rule>