<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE Workflow PUBLIC "sailpoint.dtd" "sailpoint.dtd">
<Workflow explicitTransitions="true" libraries="Identity" name="NRRC_Workflow_Candidate_Joiner_Validation" type="LCMProvisioning">
  <Variable input="true" name="project">
    <Description>ProvisioningProject which is just a compiled version of the ProvisioningPlan.</Description>
  </Variable>
  <Variable input="true" name="plan">
    <Description>The provisioning plan, which is built by a service method.</Description>
  </Variable>
  <Variable input="true" name="identityName">
    <Description>The name of the identity.</Description>
  </Variable>
  <Variable initializer="script:(identityDisplayName != void) ? identityDisplayName : resolveDisplayName(identityName)" input="true" name="identityDisplayName">
    <Description>The displayName of the identity being updated.</Description>
  </Variable>
  <Variable initializer="false" input="true" name="foregroundProvisioning">
    <Description>
      Normally provisioning is done in a step that uses the "background" option to force the workflow 
      to be suspended and resumed in a background task thread. This prevents the browser session from hanging 
      since provisioning can take a long time. For demos and testing, it can be better to do this in the foreground 
      so that provisioning will have been performed when control is returned to the user.
    </Description>
  </Variable>
  <Variable initializer="spadmin" input="true" name="fallbackApprover">
    <Description>
      A string specifying the name of the Identity that will be assigned any approvals where the owner of 
      the approver canâ€™t be resolved. Example if the scheme is "owner" and the application doesn't specify an owner.
    </Description>
  </Variable>
  <Variable initializer="false" input="true" name="optimisticProvisioning">
    <Description>
      Set to true to enable optimistic provisioning. This will cause entitlement changes to apply immediately
      rather than waiting for the next refresh/reaggregation after the provisioning system completes.
    </Description>
  </Variable>
  <Variable initializer="LCM" input="true" name="source">
    <Description>String version of sailpoint.object.Source to indicate where the request originated.</Description>
  </Variable>
  <Variable initializer="Normal" input="true" name="workItemPriority">
    <Description>
      The String version of a WorkItem.Priority. This variable is used to set the priority on all of the work items 
      generated as part of this workflow.
    </Description>
  </Variable>
  <Variable initializer="Active Directory" name="activeDirectory"/>
  <Variable initializer="false" input="true" name="doRefresh"/>
  <Variable initializer="true" input="true" name="trace"/>
  <Variable initializer="none" input="true" name="policyScheme"/>
  <Variable initializer="none" input="true" name="approvalsScheme"/>
  <Variable initializer="none" input="true" name="notificationScheme"/>
  <Variable name="workItemName"/>
  <Variable name="workItemStatus"/>
  <Variable name="errorMessages"/>
  <Variable initializer="spadmin" name="errorHandlingGroup"/>
  <Variable initializer="nikeshsinghrajput2002@gmail.com" name="IAMTeam"/>
  <Variable initializer="NRRC_EmailTemplate_Manual_WorkItem" name="manualWorkItemEmailTemplate"/>
  <RuleLibraries>
    <Reference class="sailpoint.object.Rule" name="NRRC_RuleLibrary_Active_Directory"/>
  </RuleLibraries>
  <Step icon="start" name="start" posX="78" posY="118">
    <Transition to="Check If Errors"/>
  </Step>
  <Step icon="Task" name="Check If Errors" posX="299" posY="116" resultVariable="errorMessages">
    <Script>
      <Source>
        import java.util.ArrayList;
        import java.util.List;
        import org.apache.log4j.Logger;

        Logger logs = Logger.getLogger("com.ns.workflow.NRRC_Workflow_Candidate_Joiner_Validation");
        logs.debug("Enter into the step Check If Errors");
        List errorMessages = validateCandidateJoiner(identityName);
        logs.debug("Error Messages: " + errorMessages);
        logs.debug("Exit from the step Check If Errors");
        return errorMessages;
      </Source>
    </Script>
    <Transition to="Create WorkItem">
      <Script>
        <Source>
          if (errorMessages != null &amp;&amp; !errorMessages.isEmpty()) {
            return true;
          }
          return false;
        </Source>
      </Script>
    </Transition>
    <Transition to="Stop"/>
  </Step>
  <Step icon="Default" name="Create WorkItem" posX="558" posY="111" resultVariable="workItemName">
    <Script>
      <Source>
        return createItem(errorHandlingGroup, identityName, activeDirectory, errorMessages);
      </Source>
    </Script>
    <Transition to="Wait and Check WorkItem Status"/>
  </Step>
  <Step action="sendEmail" icon="Default" name="Manual Item Email Notification" posX="428" posY="203">
    <Arg name="template" value="ref:manualWorkItemEmailTemplate"/>
    <Arg name="identityDisplayName" value="ref:identityDisplayName"/>
    <Arg name="workItemOwner" value="ref:errorHandlingGroup"/>
    <Arg name="to" value="ref:IAMTeam"/>
    <Arg name="workItemName" value="ref:workItemName"/>
    <Arg name="workItemLink">
      <Script>
        <Source>
          import sailpoint.object.WorkItem;
          import sailpoint.object.Custom;
          import org.apache.log4j.Logger;

          Logger logs = Logger.getLogger("com.ns.workflow.NRRC_Workflow_Candidate_Joiner_Validation");
          logs.debug("Enter into the step Manual WorkItem Email Notification (link generation)");

          WorkItem workItem = context.getObjectByName(WorkItem.class, workItemName);
          if (workItem != null) {
            Custom bu = context.getObjectByName(Custom.class, "MapOULink");
            String baseURL = bu.get("baseURL") + "/workitem/workItem.jsf?id=" + workItem.getId();
            logs.debug("Work Item Base URL: " + baseURL);
            return baseURL;
          }
          logs.debug("Exit from Manual WorkItem Email Notification");
        </Source>
      </Script>
    </Arg>
    <Transition to="Wait and Check WorkItem Status"/>
  </Step>
  <Step icon="Task" name="Wait and Check WorkItem Status" posX="670" posY="172" resultVariable="workItemStatus" wait="1">
    <Script>
      <Source>
        import sailpoint.object.WorkItemArchive;
        import org.apache.log4j.Logger;

        Logger log = Logger.getLogger("com.ns.workflow.NRRC_Workflow_Candidate_Joiner_Validation");
        logs.debug("Enter into the step Wait and Check WorkItem Status");

        WorkItemArchive archive = context.getObjectByName(WorkItemArchive.class, workItemName);
        if (archive != null) {
          logs.debug("Exit from the step Wait and Check WorkItem Status");
          return true;
        }

        logs.debug("Exit from the step Wait and Check WorkItem Status - Pending");
        return false;
      </Source>
    </Script>
    <Transition to="Stop" when="script:workItemStatus == true"/>
    <Transition to="Wait and Check WorkItem Status"/>
  </Step>
  <Step icon="Stop" name="Stop" posX="951" posY="112"/>
</Workflow>