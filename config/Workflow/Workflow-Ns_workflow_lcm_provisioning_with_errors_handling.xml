<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE Workflow PUBLIC "sailpoint.dtd" "sailpoint.dtd">
<Workflow explicitTransitions="true" libraries="Identity" name="NS_Workflow_LCM_Provisioning_With_Errors_Handling" type="LCMProvisioning">
  <Variable name="project">
    <Description>ProvisioningProject which is just a compiled version of the ProvisioningPlan.</Description>
  </Variable>
  <Variable input="true" name="plan">
    <Description>The provisioning plan, which is built by a service method.</Description>
  </Variable>
  <Variable input="true" name="identityName">
    <Description>The name of the identity.</Description>
  </Variable>
  <Variable initializer="script:(identityDisplayName != void) ? identityDisplayName : resolveDisplayName(identityName)" input="true" name="identityDisplayName">
    <Description>The displayName of the identity being updated. Query for this using a projection query and fall back to the name.</Description>
  </Variable>
  <Variable initializer="false" input="true" name="foregroundProvisioning">
    <Description>Normally provisioning is done in a step that uses the &amp;quot;background&amp;quot; option to force the workflow to be suspend and be resumed in a
      background task thread.  This prevents the browser session from hanging since provision can sometimes take a long time.  For demos
      and testing it can be better to do this in the foreground so that provisioning will have been performed when control is returned to the
      user. This prevents having to run the Perform Maintenance task to see the results of the request.</Description>
  </Variable>
  <Variable initializer="spadmin" input="true" name="fallbackApprover">
    <Description>A String that specifies the name of the Identity that will be assigned any approvals where the owner of the approver
      can&amp;#39;t be resolved. Example if the scheme is &amp;quot;owner&amp;quot; and the application doesn&amp;#39;t specify and owner.</Description>
  </Variable>
  <Variable initializer="false" input="true" name="optimisticProvisioning">
    <Description>Set to true to enable optimistic provisioning.  This will cause changes to the entitlements compiled from role assignments to be
      applied immediately to the identity cube rather than waiting for the next refresh/reaggregation after the provisioning system completes the request.</Description>
  </Variable>
  <Variable initializer="LCM" input="true" name="source">
    <Description>String version of sailpoint.object.Source to indicate where the request originated. Defaults to LCM.</Description>
  </Variable>
  <Variable initializer="Normal" input="true" name="workItemPriority">
    <Description>The String version of a WorkItem.Priority. This variable is used to set the priority on all of the workitems generated as part
      of this workflow and also set on the IdentityRequest object.</Description>
  </Variable>
  <Variable initializer="false" input="true" name="doRefresh"/>
  <Variable initializer="false" input="true" name="trace"/>
  <Variable initializer="none" input="true" name="policyScheme"/>
  <Variable initializer="none" input="true" name="approvalScheme"/>
  <Variable initializer="none" input="true" name="notificationScheme"/>
  <Variable name="errorMessages"/>
  <Variable name="workItemName"/>
  <Variable name="workItemStatus"/>
  <Variable initializer="NS_EmailTemplate_Manual_WorkItem_Notification" name="manualWorkItemEmailTemplate"/>
  <Variable initializer="Exception_Management_Team" name="errorManagementGroup"/>
  <RuleLibraries>
    <Reference class="sailpoint.object.Rule" name="NS_Global_RuleLibrary_Utils"/>
  </RuleLibraries>
  <Step icon="Start" name="Start" posX="18" posY="11">
    <Transition to="Provision"/>
  </Step>
  <Step icon="Provision" name="Provision" posX="275" posY="12">
    <Arg name="identityEmailTemplate"/>
    <Arg name="enableRetryRequest"/>
    <Arg name="securityOfficerElectronicSignature"/>
    <Arg name="fallbackApprover" value="ref:fallbackApprover"/>
    <Arg name="endOnManualWorkItems"/>
    <Arg name="userEmailTemplate"/>
    <Arg name="policiesToCheck"/>
    <Arg name="workItemComments"/>
    <Arg name="identityRequestId"/>
    <Arg name="approvalSplitPoint"/>
    <Arg name="source" value="ref:source"/>
    <Arg name="identityDisplayName"/>
    <Arg name="foregroundProvisioning" value="ref:foregroundProvisioning"/>
    <Arg name="ownerElectronicSignature"/>
    <Arg name="batchRequestItemId"/>
    <Arg name="saveUnmanagedPlan_WithProjectArgument"/>
    <Arg name="splitPlans"/>
    <Arg name="doRefresh" value="ref:doRefresh"/>
    <Arg name="plan" value="ref:plan"/>
    <Arg name="flow"/>
    <Arg name="identityElectronicSignature"/>
    <Arg name="identityName" value="ref:identityName"/>
    <Arg name="approvalSet"/>
    <Arg name="violationReviewDecision"/>
    <Arg name="filterRejects"/>
    <Arg name="splitProjects"/>
    <Arg name="requireCommentsForDenial"/>
    <Arg name="requesterEmailTemplate"/>
    <Arg name="approvalEmailTemplate"/>
    <Arg name="ticketManagementApplication"/>
    <Arg name="securityOfficerName"/>
    <Arg name="approvingIdentities"/>
    <Arg name="managerEmailTemplate"/>
    <Arg name="ticketId"/>
    <Arg name="approvalScheme" value="ref:approvalScheme"/>
    <Arg name="allowRequestsWithViolations"/>
    <Arg name="workItemPriority" value="ref:workItemPriority"/>
    <Arg name="managerElectronicSignature"/>
    <Arg name="requireViolationReviewComments"/>
    <Arg name="splitApprovalSet"/>
    <Arg name="approvalMode"/>
    <Arg name="trace" value="ref:trace"/>
    <Arg name="endOnProvisioningForms"/>
    <Arg name="splitWorkItemComments"/>
    <Arg name="requireCommentsForApproval"/>
    <Arg name="notificationScheme" value="ref:notificationScheme"/>
    <Arg name="policyViolations"/>
    <Arg name="policyScheme" value="ref:policyScheme"/>
    <Arg name="setPreviousApprovalDecisions"/>
    <Arg name="optimisticProvisioning" value="ref:optimisticProvisioning"/>
    <Arg name="securityOfficerEmailTemplate"/>
    <Return name="project" to="project"/>
    <WorkflowRef>
      <Reference class="sailpoint.object.Workflow" name="LCM Provisioning"/>
    </WorkflowRef>
    <Transition to="Check If Errors"/>
  </Step>
  <Step icon="Task" name="Check If Errors" posX="364" posY="12" resultVariable="errorMessages">
    <Script>
      <Source>
      import java.util.ArrayList;
      import java.util.List;
      import org.apache.log4j.Logger;

      Logger log = Logger.getLogger("com.ns.workflow.NS_Workflow_LCM_Provisioning_With_Errors_Handling");
      log.debug("Enter into the step Check If Errors");
      List errorMessages = getRequestErrorMessages(project);
      log.debug("Error Messages : "+errorMessages);
      log.debug("Exit from the step Check If Errors");
      return  errorMessages;
      </Source>
    </Script>
    <Transition to="Create WorkItem">
      <Script>
        <Source>
        if(errorMessages != null &amp;&amp; !errorMessages.isEmpty()){
          return true;
        }
        return false;
        </Source>
      </Script>
    </Transition>
    <Transition to="Stop"/>
  </Step>
  <Step icon="Task" name="Create WorkItem" posX="344" posY="95" resultVariable="workItemName">
    <Script>
      <Source>
      return createWorkItem(errorManagementGroup, project);
      </Source>
    </Script>
    <Transition to="Manual WorkItem Email Notification"/>
  </Step>
  <Step action="sendEmail" icon="Default" name="Manual WorkItem Email Notification" posX="428" posY="203">
    <Arg name="template" value="ref:manualWorkItemEmailTemplate"/>
    <Arg name="identityDisplayName" value="ref:identityDisplayName"/>
    <Arg name="workItemOwner" value="ref:errorManagementGroup"/>
    <Arg name="to">
      <Script>
        <Source>
        import org.apache.log4j.Logger;     
        Logger log = Logger.getLogger("com.ns.workflow.NS_Workflow_LCM_Provisioning_With_Errors_Handling");

        log.debug("Enter into the step Manual WorkItem Email Notification");
        List groupMembersEmailList = getWorkGroupMembersEmail(errorManagementGroup);
        String emails = null;
        if(groupMembersEmailList.size() &gt; 0){
          emails = String.join(",", groupMembersEmailList);
        }else{
          emails = IdentityandAccessManagement@test.com;
        }                          
        log.debug("Exit from the step Manual WorkItem Email Notification "+emails);
        return emails;
        </Source>
      </Script>
    </Arg>
    <Arg name="workItemName" value="ref:workItemName"/>
    <Arg name="workItemLink">
      <Script>
        <Source>
        import sailpoint.object.WorkItem;
        import sailpoint.object.Custom;
        import org.apache.log4j.Logger;

        Logger log = Logger.getLogger("com.ns.workflow.NS_Workflow_LCM_Provisioning_With_Errors_Handling");

        log.debug("Enter into the step Manual WorkItem Email Notification");
        WorkItem workItem = context.getObjectByName(WorkItem.class, workItemName);
        if(workItem != null){
          Custom bu = context.getObjectByName(Custom.class, "NS_CustomObject_Active_Directory");
          String baseURL = bu.get("baseURL")+"workitem/workItem.jsf?id="+workItem.getId();
          log.debug("Work Item Base URL : baseURL");
          log.debug("Exit from the step Manual WorkItem Email Notification");
          return baseURL;
        }
        </Source>
      </Script>
    </Arg>
    <Transition to="Wait and Check WorkItem Status"/>
  </Step>
  <Step icon="Task" name="Wait and Check WorkItem Status" posX="720" posY="177" resultVariable="workItemStatus" wait="5">
    <Script>
      <Source>
      import sailpoint.object.WorkItemArchive;
      import org.apache.log4j.Logger;
      Logger log = Logger.getLogger("com.ns.workflow.NS_Workflow_LCM_Provisioning_With_Errors_Handling");

      log.debug("Enter into the step Wait and Check WorkItem Status");
      WorkItemArchive archive = context.getObjectByName(WorkItemArchive.class, workItemName);
      if(archive != null){
        log.debug("Exit from the step Wait and Check WorkItem Status");
        return true;
      }
      log.debug("Exit from the step Wait and Check WorkItem Status");
      return false;
      </Source>
    </Script>
    <Transition to="Stop" when="script:workItemStatus == true"/>
    <Transition to="Wait and Check WorkItem Status"/>
  </Step>
  <Step icon="Stop" name="Stop" posX="951" posY="12"/>
</Workflow>