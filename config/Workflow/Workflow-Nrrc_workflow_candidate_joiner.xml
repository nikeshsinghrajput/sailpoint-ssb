<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE Workflow PUBLIC "sailpoint.dtd" "sailpoint.dtd">
<Workflow explicitTransitions="true" libraries="Identity" name="NRRC_Workflow_Candidate_Joiner" type="IdentityLifecycle">
  <Variable input="true" name="trigger">
    <Description>The IdentityTrigger</Description>
  </Variable>
  <Variable input="true" name="event">
    <Description>The IdentityChangeEvent</Description>
  </Variable>
  <Variable input="true" name="identityName">
    <Description>The name of the identity.</Description>
  </Variable>
  <Variable name="plan">
    <Description>The provisioning plan which is built during the workflow.</Description>
  </Variable>
  <Variable initializer="script:(identityDisplayName != void) ? identityDisplayName : resolveDisplayName(identityName)" input="true" name="identityDisplayName">
    <Description>The displayName of the identity being updated. Query for this using a projection query and fall back to the name.</Description>
  </Variable>
  <Variable initializer="string:false" input="true" name="trace">
    <Description>Used for debugging this workflow and when set to true trace Birthright Provisioning.</Description>
  </Variable>
  <Variable initializer="spadmin" name="fallbackApprover">
    <Description>
      A string specifying the name of the Identity that will be assigned any approvals where the owner of 
      the approver canâ€™t be resolved. Example if the scheme is "owner" and the application doesn't specify an owner.
    </Description>
  </Variable>
  <Variable initializer="NRRC_EmailTemplate_Joiner_Completion_Notification" name="MailCreationEmailTemplate"/>
  <Variable initializer="Active Directory" name="activeDirectory"/>
  <Variable initializer="nikeshsinghrajput2002@gmail.com" name="IAMTeam"/>
  <Variable name="managerDisplayName"/>
  <Variable name="managerEmail"/>
  <Variable name="employeeId"/>
  <Variable name="project"/>
  <Variable input="true" name="password" output="true"/>
  <RuleLibraries>
    <Reference class="sailpoint.object.Rule" name="NRRC_RuleLibrary_Active_Directory"/>
  </RuleLibraries>
  <Step icon="start" name="start" posX="101" posY="113">
    <Script>
      <Source>
        import sailpoint.object.Identity;
        import sailpoint.object.Link;
        import org.apache.log4j.Logger;
        Logger logs = Logger.getLogger("com.ns.workflow.NRRC_Workflow_Candidate_Joiner");
        logs.debug("Entering into the Start step");
        String managerDisplayName = null;
        String managerEmail = null;
        Identity identity = context.getObjectByName(Identity.class, identityName);
        Identity manager = identity.getManager();
        if(manager.getDisplayName() != null)
          managerDisplayName = manager.getDisplayName();
        else
          managerDisplayName = "spadmin";
        logs.debug("managerDisplayName :::::::::::::::::: "+managerDisplayName);
        wfcontext.getWorkflowCase().put("managerDisplayName", managerDisplayName);
        if(manager.getEmail() != null)
          managerEmail = manager.getEmail();
        else
          managerEmail = "IAMTeam@test.com";
        logs.debug("managerEmail :::::::::::::::::: "+managerEmail);
        wfcontext.getWorkflowCase().put("managerEmail", managerEmail);
        logs.debug("Exit from the Start step");
      </Source>
    </Script>
    <Transition to="Pre Joiner Validation"/>
  </Step>
  <Step icon="Default" name="Pre Joiner Validation" posX="1100" posY="114">
    <Arg name="approvalScheme"/>
    <Arg name="identityName" value="ref:identityName"/>
    <Arg name="notificationScheme"/>
    <Arg name="fallbackApprover"/>
    <Arg name="project"/>
    <Arg name="workItemPriority"/>
    <Arg name="workItemStatus"/>
    <Arg name="source"/>
    <Arg name="policyScheme"/>
    <Arg name="manualWorkItemEmailTemplate"/>
    <Arg name="identityDisplayName"/>
    <Arg name="foregroundProvisioning"/>
    <Arg name="ErrorManagementGroup"/>
    <Arg name="trace"/>
    <Arg name="doRefresh"/>
    <Arg name="optimisticProvisioning"/>
    <Arg name="workItemName"/>
    <Arg name="plan"/>
    <Arg name="errorMessages"/>
    <WorkflowRef>
      <Reference class="sailpoint.object.Workflow" name="NRRC_Workflow_Candidate_Joiner_Validation"/>
    </WorkflowRef>
    <Transition to="Create Active Directory"/>
  </Step>
  <Step icon="Task" name="Create Active Directory" posX="229" posY="109" resultVariable="plan">
    <Script>
      <Source>
	   import sailpoint.object.Identity;
        import sailpoint.object.ProvisioningPlan;
        import sailpoint.object.ProvisioningPlan.AccountRequest;
        import org.apache.log4j.Logger;
        Logger logs = Logger.getLogger("com.ns.workflow.NRRC_Workflow_Candidate_Joiner");
        logs.debug("Entering into the Create Active Directory in IIQ Step");

        ProvisioningPlan plan = new ProvisioningPlan();
        List accountRequestList = new ArrayList();
        Identity identityObject = context.getObjectByName(Identity.class,identityName);
        AccountRequest accountRequest = createADAccount(identityName, activeDirectory);
        AttributeRequest attrReq = accountRequest.getAttributeRequest("password");
        String password = attrReq.getValue();
        if(password!=null) {
          wfcontext.getWorkflowCase().put("password", password);
        }
        accountRequestList.add(accountRequest);
        plan.setAccountRequests(accountRequestList);
        plan.setIdentity(identityObject);
        plan.setNativeIdentity(identityName);

        logs.debug("Exit from the Create Active Directory in IIQ Step"+plan.toXml());
        return plan;
    </Source>
    </Script>
    <Transition to="Provision"/>
  </Step>
  <Step icon="Provision" name="Provision" posX="275" posY="12">
    <Arg name="plan" value="ref:plan"/>
    <Arg name="identityName" value="ref:identityName"/>
    <Arg name="foregroundProvisioning" value="ref:foregroundProvisioning"/>
    <Arg name="fallbackApprover" value="ref:fallbackApprover"/>
    <Arg name="optimisticProvisioning" value="ref:optimisticProvisioning"/>
    <Arg name="source" value="ref:source"/>
    <Arg name="workItemPriority" value="ref:workItemPriority"/>
    <Arg name="doRefresh" value="ref:doRefresh"/>
    <Arg name="trace" value="ref:trace"/>
    <Arg name="policyScheme" value="ref:policyScheme"/>
    <Arg name="approvalScheme" value="ref:approvalScheme"/>
    <Arg name="notificationScheme" value="ref:notificationScheme"/>
    <Return name="project" to="project"/>
    <WorkflowRef>
      <Reference class="sailpoint.object.Workflow" name="LCM Provisioning"/>
    </WorkflowRef>
    <Transition to="Check If Errors"/>
  </Step>
  <Step icon="Task" name="Check If Errors" posX="364" posY="12" resultVariable="errorMessages">
    <Script>
      <Source>
      import java.util.ArrayList;
      import java.util.List;
      import org.apache.log4j.Logger;
      Logger logs = Logger.getLogger("com.ns.workflow.NRRC_Workflow_Candidate_Joiner");
      logs.debug("Enter into the step Check If Errors");
      List errorMessages = getRequestErrorMessages(project);
      logs.error("Error Messages : "+errorMessages);
      logs.debug("Exit from the step Check If Errors");
      return  errorMessages;
      </Source>
    </Script>
    <Transition to="end">
      <Script>
        <Source>
        if(errorMessages != null &amp;&amp; !errorMessages.isEmpty()){
          return true;
        }
        return false;
        </Source>
      </Script>
    </Transition>
    <Transition to="Send Email Notification For Mail Creation"/>
  </Step>
  <Step icon="Task" name="Email Wait" posX="670" posY="172" wait="1">
    <Transition to="Send Email Notification For Mail Creation"/>
  </Step>
  <Step action="sendEmail" icon="Email" name="Send Email Notification For Mail Creation" posX="428" posY="203">
    <Arg name="template" value="ref:MailCreationEmailTemplate"/>
    <Arg name="identityDisplayName" value="ref:identityDisplayName"/>
    <Arg name="managerDisplayName" value="ref:managerDisplayName"/>
    <Arg name="password" value="ref:password"/>
    <Arg name="email">
      <Script>
        <Source>
          import org.apache.log4j.Logger;
		  
          Logger logs = Logger.getLogger("com.ns.workflow.NRRC_Workflow_Candidate_Joiner");
          logs.debug("Retrive Email From AD For Mail Creation");
		  String email = null;
          Link adLink  = getADAccountLink(identityName);
          if(adLink!=null &amp;&amp; adLink.getAttribute("mail")!= null){
			email = adLink.getAttribute("mail");
		  }
		  logs.debug("email:::::::::"+email);
          return email;
        </Source>
      </Script>
    </Arg>
    <Arg name="to" value="ref:IAMTeam"/>
    <Transition to="Update Account Name and Email to GRP"/>
  </Step>
  <Step icon="Task" name="Update Account Name and Email to GRP" posX="939" posY="172">
    <Script>
      <Source>
        import org.apache.log4j.Logger;
		
        Logger logs = Logger.getLogger("com.ns.workflow.NRRC_Workflow_Candidate_Joiner");
		logs.debug("Update Account Name and Email to GRP step called");
      </Source>
    </Script>
    <Transition to="Send SMS Notification To User"/>
  </Step>
  <Step icon="Task" name="Send SMS Notification To User" posX="939" posY="172">
    <Script>
      <Source>
	  
	    import sailpoint.object.Identity;
		import sailpoint.tools.Util;
		import sailpoint.object.Custom;
		import java.net.HttpURLConnection;
		import java.net.URL;
		import java.io.OutputStream;
		import java.io.BufferedReader;
		import java.io.InputStreamReader;
		import org.apache.log4j.Logger;
		
        Logger logs = Logger.getLogger("com.ns.workflow.NRRC_Workflow_Candidate_Joiner");
		logs.debug("Send SMS Notification To User step started ");
		String baseURL = null;
		String apiUrl=null;
		Custom cs = context.getObjectByName(Custom.class, "MapOULink");
		if (cs != null) {
			apiUrl = cs.get("smsURL");
			logs.debug("apiUrl : " + apiUrl);
			 
		}
        Identity identityObject = context.getObjectByName(Identity.class,identityName);
		String phone= identityObject.getStringAttribute("phone");
		if(Util.isNotNullOrEmpty(phone)){
        String textMessage = "Your Active Directory account is created";
		try {
        
        String jsonBody = "{ \"text\": \"" + textMessage + "\", \"phone\": \"" + phone + "\" }";

        logs.info("Sending JSON to API: " + jsonBody);
        URL url = new URL(apiUrl);
        HttpURLConnection conn = (HttpURLConnection) url.openConnection();

        conn.setRequestMethod("POST");
        conn.setRequestProperty("Accept", "application/json");
        conn.setRequestProperty("Content-Type", "application/json");
        conn.setDoOutput(true);

        // Write JSON payload
        OutputStream os = conn.getOutputStream();
        os.write(jsonBody.getBytes("UTF-8"));
        os.flush();
        os.close();

        int responseCode = conn.getResponseCode();
        logs.info("API Response Code: " + responseCode);

        BufferedReader in = new BufferedReader(new InputStreamReader(conn.getInputStream()));
        String inputLine;
        StringBuffer response = new StringBuffer();

        while ((inputLine = in.readLine()) != null) {
            response.append(inputLine);
        }
        in.close();

        logs.info("API Response: " + response.toString());
        conn.disconnect();
        } catch (Exception e) {
			logs.error("Error calling Send API: " + e);
        }
		}
      </Source>
    </Script>
    <Transition to="Set Status"/>
  </Step>
  <Step icon="Task" name="Set Status" posX="939" posY="172">
    <Script>
      <Source>
        import sailpoint.object.Identity;
        import org.apache.log4j.Logger;
		
        Logger logs = Logger.getLogger("com.ns.workflow.NRRC_Workflow_Candidate_Joiner");
        logs.debug("Entering into the step Set Status");
        String setStatus=null;
        Identity identity = context.getObjectByName(Identity.class, identityName);
        String status = identity.getAttribute("status");
		logs.debug("status:::::::"+status);
        if(status != null &amp;&amp; status.contains("Joiner-Started")){
          setStatus="Joiner-Completed";
        }
        identity.setAttribute("status", setStatus);
        context.startTransaction();
        context.saveObject(identity);
        context.commitTransaction();

        logs.debug("Exit from the step Set Status");
      </Source>
    </Script>
    <Transition to="Refresh Identity"/>
  </Step>
  <Step action="call:refreshIdentity" icon="Task" name="Refresh Identity" posX="954" posY="114">
    <Arg name="identityName" value="ref:identityName"/>
    <Arg name="provision" value="true"/>
    <Arg name="refreshIdentityEntitlements" value="true"/>
    <Arg name="synchronizeAttributes" value="true"/>
    <Arg name="correlateEntitlements" value="true"/>
    <Arg name="doRefresh" value="true"/>
    <Description>
      Add arguments as necessary to enable refresh features. Typically you only want this
      to correlate roles and possibly provision if we notice new assigned roles.
      Note that provisioning will be done in the Identity Refresh workflow so if there
      are any provisioning forms to display we won't feed them directly to the
      current user, they'll have to return to the inbox.
    </Description>
    <Transition to="end"/>
  </Step>
  <Step icon="Stop" name="end" posX="939" posY="254"/>
</Workflow>