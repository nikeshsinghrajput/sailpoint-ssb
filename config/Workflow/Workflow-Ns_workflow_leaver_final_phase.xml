<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE Workflow PUBLIC "sailpoint.dtd" "sailpoint.dtd">
<Workflow explicitTransitions="true" libraries="Identity" name="NS_Workflow_Leaver_final_Phase" type="IdentityLifecycle">
  <Variable input="true" name="trigger">
    <Description>The IdentityChangeEvent.  It can be used to build
    the provisioning plan, but does not need to be
    persisted with the case, so marked as transient.</Description>
  </Variable>
  <Variable input="true" name="event" transient="true">
    <Description>The IdentityChangeEvent.  It can be used to build
    the provisioning plan, but does not need to be
    persisted with the case, so marked as transient.</Description>
  </Variable>
  <Variable input="true" name="identityName">
    <Description>Name of the identity.</Description>
  </Variable>
  <Variable initializer="script:(identityDisplayName != void) ? identityDisplayName : resolveDisplayName(identityName)" input="true" name="identityDisplayName">
    <Description>The displayName of the identity being updated.
      For this query using a projection query and fall back to the name.</Description>
  </Variable>
  <Variable name="plan">
    <Description>The provisioning plan, which is built by a service method.</Description>
  </Variable>
  <Variable editable="true" initializer="false" name="optimisticProvisioning">
    <Description>Set to true to enable optimistic provisioning.  This will cause
    changes to the entitlements compiled from role assignments to be
    applied immediately to the identity cube rather than waiting
    until the next refresh/aggregation after the provisioning system
    completes the request.</Description>
  </Variable>
  <Variable editable="true" initializer="false" name="foregroundProvisioning">
    <Description>Normally provisioning is done in the last step that uses the &amp;quot;background&amp;quot;
    option to force the workflow to be resumed in a
    background workflow thread.  This prevents the browser session from
    hanging since provision can sometimes take a long time.  For demos
    and testing it can be better to do this in the foreground so that
    provisioning will have been performed when control is returned to the
    user.  This prevents having to run the Perform Maintenance task to
    see the results of the request.</Description>
  </Variable>
  <Variable initializer="spadmin" input="true" name="fallbackApprover">
    <Description>A String that specifies the name of the Identity that will
    be assigned any approvals where none of the approver
    can&amp;#39;t be resolved. Example if the scheme is &amp;quot;owner&amp;quot; and the
    application doesn&amp;#39;t specify any owner.</Description>
  </Variable>
  <Variable initializer="LCM" input="true" name="source">
    <Description>String version of sailpoint.object.Source to indicate
    where the request originated.  Defaults to LCM.</Description>
  </Variable>
  <Variable initializer="false" input="true" name="trace">
    <Description>Used for debugging this workflow and when set to true trace
    will be sent to stdout.</Description>
  </Variable>
  <Variable name="project">
    <Description>ProvisioningProject which is just a compiled version of the ProvisioningPlan.</Description>
  </Variable>
  <Variable name="identityRequestId" output="true">
    <Description>The sequence id of the Identity request object which is stored in
    the name field of the identity request.</Description>
  </Variable>
  <Variable name="cart" output="true">
    <Description>This variable includes all ApprovalItems that are part of
    the request process and is updated during the AfterScript
    of the approval process by assimilating the decisions
    and comments from the Approvals copy of the ApprovalItem.</Description>
  </Variable>
  <Variable initializer="Normal" input="true" name="workItemPriority">
    <Description>The String version of a WorkItem.Priority. This variable is
    used to set the priority on all of the work items generated
    as part of this workflow and also set on the IdentityRequest
    object.</Description>
  </Variable>
  <Variable name="CurrentNSStatus"/>
  <Description>The IdentityTrigger</Description>
  <RuleLibraries>
    <Reference class="sailpoint.object.Rule" name="NS_Global_RuleLibrary_Utils"/>
    <Reference class="sailpoint.object.Rule" name="NS_RuleLibrary_Leaver"/>
  </RuleLibraries>
  <Step icon="Start" name="Start" posX="35" posY="19">
    <Script>
      <Source>
        import org.apache.log4j.Logger;

        Logger logs = Logger.getLogger("com.ns.workflow.NS_Workflow_Leaver_final_Phase");
        logs.debug("Entering to Start step");
		logs.debug("Exit from Start step");
      </Source>
    </Script>
    <Transition to="Remove Entitlements">
      <Script>
        <Source>
          String entitlementsPresent=areEntitlementsPresent(identityName);
          if(entitlementsPresent.equalsIgnoreCase("Yes")){
            return true;
          }
          return false;
        </Source>
      </Script>
    </Transition>
    <Transition to="setStatus"/>
  </Step>
  <Step icon="Message" name="Remove Entitlements" posX="103" posY="104" resultVariable="plan">
    <Description>Removes the Entitlement Except the Licenced Group and Excludes the Entitlements which are present in applicationExclusionList .</Description>
    <Script>
      <Source>
        import java.util.List;
        import java.util.ArrayList;
        import sailpoint.object.Identity;
        import sailpoint.object.Attributes;
        import sailpoint.object.EntitlementGroup;
        import sailpoint.object.Custom;
        import sailpoint.object.*;
        import sailpoint.api.Provisioner;
        import org.apache.log4j.Logger;
        import org.apache.log4j.Level;
        import sailpoint.tools.GeneralException;
        import sailpoint.object.QueryOptions;
        import sailpoint.object.Filter;
        import sailpoint.object.IdentityEntitlement;

        Logger logs = Logger.getLogger("com.ns.workflow.NS_Workflow_Leaver_final_Phase");
        /****This Step Removes Entitlements*********/

        logs.debug("\n************************Entering Remove Entitlements step");
        Iterator itr = null;
        String idObj = null;
        List applicationToExclude = null;
        String memberOfGroup1 = null;

        try{
            ProvisioningPlan rePlan = new ProvisioningPlan();
            List accountRequestList = new ArrayList();
            Custom customObject = context.getObjectByName(Custom.class, "NS_CustomObject_IdentityEvent_Leaver");
            if(customObject !=null)
            {
                Attributes attributes = customObject.getAttributes();
                Map customObjectMap = attributes.getMap();
                if(customObjectMap != null){

                    applicationToExclude = customObjectMap.get("appExclusionListforEntRemoval");
                    logs.debug("applicationToExclude :: "+applicationToExclude);
                }

                Custom cs = context.getObjectByName(Custom.class, "NS_CustomObject_Active_Directory");
                if(cs != null)
                {
                    licensedGroup = cs.get("licensedGroup");
                    logs.debug("License group Value is :: "+ licensedGroup);
                }

                Identity identityObject = context.getObjectByName(Identity.class,identityName);
                Filter filter = Filter.eq("identity.id",identityObject.getId());
                QueryOptions qo = new QueryOptions();
                qo.addFilter(filter);
                qo.setDistinct(true);
                qo.setCloneResults(true);
                itr = context.search(IdentityEntitlement.class, qo, "id");

                while(null != itr &amp;&amp; itr.hasNext())
                {
                    Object[] row = (Object[]) itr.next();
                    idObj = (String) row[0];
                    IdentityEntitlement ieObj = context.getObjectById(IdentityEntitlement.class, idObj);
                    if(ieObj != null &amp;&amp; ieObj.getNativeIdentity()!= null &amp;&amp; ieObj.getValue() != null &amp;&amp; ieObj.getApplication() != null){
                        String entValue = ieObj.getValue();
                        String entAttr = ieObj.getName();
                        String entApp = ieObj.getAppName();
                        if(!applicationToExclude.contains(entApp)  &amp;&amp; !entValue.equalsIgnoreCase(licensedGroup)) {
                            ProvisioningPlan.AccountRequest accountRequest = new ProvisioningPlan.AccountRequest();
                            accountRequest.setOperation(ProvisioningPlan.AccountRequest.Operation.Modify);
                            accountRequest.add(new ProvisioningPlan.AttributeRequest(entAttr, ProvisioningPlan.Operation.Remove, entValue));
                            accountRequest.setApplication(ieObj.getApplication().getName());
                            accountRequest.setNativeIdentity(ieObj.getNativeIdentity());
                            accountRequestList.add(accountRequest);
                        }
                    }
                }
                rePlan.setAccountRequests(accountRequestList);
                rePlan.setIdentity(identityObject);
                rePlan.setNativeIdentity(identityName);
                logs.debug("Plan of Remove Entitlements step :: "+rePlan.toXml());

                return rePlan;

            }
        }
        catch(GeneralException e){
            logs.debug("Removal of entitlements step failed");
        }

      </Source>
    </Script>
    <Transition to="Provision"/>
  </Step>
  <Step icon="Provision" name="Provision" posX="208" posY="92">
    <Arg name="foregroundProvisioning" value="false"/>
    <Arg name="doRefresh" value="false"/>
    <Arg name="plan" value="ref:plan"/>
    <Arg name="identityName" value="ref:identityName"/>
    <Arg name="approvalScheme" value="none"/>
    <Arg name="trace" value="true"/>
    <Arg name="notificationScheme" value="none"/>
    <Arg name="policyScheme" value="none"/>
    <Arg name="optimisticProvisioning"/>
    <Return name="project" to="project"/>
    <WorkflowRef>
      <Reference class="sailpoint.object.Workflow" name="NS_Workflow_LCM_Provisioning_With_Errors_Handling"/>
    </WorkflowRef>
    <Transition to="setStatus"/>
  </Step>
  <Step name="setStatus" posX="845" posY="103" resultVariable="CurrentNSStatus">
    <Script>
      <Source>
        import sailpoint.object.Identity;
        Identity iden = context.getObjectByName(Identity.class, identityName);
        String CurrentNSStatus= iden.getAttribute("nsStatus");
        if(iden != null)
        {
          CurrentNSStatus=setStatus(identityName);
        }
        wfcontext.setVariable("CurrentNSStatus", CurrentNSStatus);
        return CurrentNSStatus;
      </Source>
    </Script>
    <Transition to="Move AD OU to disable OU">
      <Script>
        <Source>
          if(CurrentNSStatus.equalsIgnoreCase("Leaver-Move-To-DisabledOU-Started"))
          {
              return true;
          }
          else
          {
              return false;
          }
        </Source>
      </Script>
    </Transition>
    <Transition to="Remove license group">
      <Script>
        <Source>
          if(CurrentNSStatus.equalsIgnoreCase("Leaver-Remove-License-Started"))
          {
              return true;
          }
          else
          {
              return false;
          }
        </Source>
      </Script>
    </Transition>
    <Transition to="Update telephone number">
      <Script>
        <Source>
          if(CurrentNSStatus.equalsIgnoreCase("Leaver-Update-Attribute-Started"))
          {
              return true;
          }
          else
          {
              return false;
          }
        </Source>
      </Script>
    </Transition>
    <Transition to="AD Account Aggregation">
      <Script>
        <Source>
          if(CurrentNSStatus.equalsIgnoreCase("Leaver-AD-Aggregation-Started"))
          {
              return true;
          }
          else
          {
              return false;
          }
        </Source>
      </Script>
    </Transition>
    <Transition to="Refresh Identity">
      <Script>
        <Source>
          if(CurrentNSStatus.equalsIgnoreCase("Leaver-Final-Phase-Completed"))
          {
              return true;
          }
          else
          {
              return false;
          }
        </Source>
      </Script>
    </Transition>
  </Step>
  <Step icon="Message" name="Remove license group" posX="292" posY="307" resultVariable="plan">
    <Description>This step Removes the Licensed Group Assigned to SRIIQ AD Master Account</Description>
    <Script>
      <Source>
        import sailpoint.object.ProvisioningPlan;
        import sailpoint.object.ProvisioningPlan.AccountRequest;
        import sailpoint.object.ProvisioningPlan.AccountRequest;
        import sailpoint.object.ProvisioningPlan.AttributeRequest;
        import sailpoint.object.ProvisioningPlan.Operation;
        import java.util.List;
        import java.util.ArrayList;
        import sailpoint.object.Identity;
        import sailpoint.object.Attributes;
        import sailpoint.object.Link;
        import sailpoint.object.Custom;
        import sailpoint.object.Application;
        import sailpoint.object.EntitlementGroup;
        import sailpoint.api.Provisioner;
        import org.apache.log4j.Logger;
        import org.apache.log4j.Level;
        import sailpoint.tools.GeneralException;

        Logger logs = Logger.getLogger("com.ns.workflow.NS_Workflow_Leaver_final_Phase");
        logs.debug("Entering into the step leaver license Revocation");

        /*****This Step Removes license group*****/

        ProvisioningPlan plan = new ProvisioningPlan();
        Identity identityObject = context.getObjectByName(Identity.class,identityName);
        Link adLink= null; //Calling AD Master Account Promotion Logic
        String appName = null;
        List memberOfNSIIQ = null;

        try{
            Custom cs = context.getObjectByName(Custom.class, "NS_CustomObject_Active_Directory");
            if (cs != null)
            {
                Map map = cs.getAttributes();
                appName = map.get("AdAppName");
                adLink = getADAccountLink(identityName);

                logs.debug("SRIIQ Application Name is :: "+ appName);
                licensedGroup = map.get("licensedGroup");
                logs.debug("license group Value is :: "+ licensedGroup);
            }

            if(identityObject!=null)
            {
                if(adLink != null) {
					if(adLink.getAttribute("memberOf") instanceof List){
						memberOfNSIIQ = adLink.getAttribute("memberOf");
					}else{
						memberOfNSIIQ = Arrays.asList(adLink.getAttribute("memberOf"));
					}                 
                    logs.debug("Roles for SR AD Account:"+memberOfNSIIQ);
                    adDistinguishedName = adLink.getAttribute("distinguishedName");
                }

                if(memberOfNSIIQ != null &amp;&amp; !memberOfNSIIQ.isEmpty() &amp;&amp; memberOfNSIIQ.contains(licensedGroup)){
                    // Removing Licensed Group
                    AccountRequest accountRequest = new AccountRequest();
                    accountRequest.setOperation(AccountRequest.Operation.Modify);
                    accountRequest.setApplication(appName);
                    List accountRequestList = new ArrayList();
                    accountRequest.add(new AttributeRequest("memberOf", ProvisioningPlan.Operation.Remove, licensedGroup));
                    accountRequest.setNativeIdentity(adDistinguishedName);
                    accountRequestList.add(accountRequest);
                    plan.setAccountRequests(accountRequestList);
                    plan.setIdentity(identityObject);
                    plan.setNativeIdentity(identityName);                 
                }
            }
        }
        catch(GeneralException e){
           logs.debug("Removal of license group step failed");
        }
		logs.debug("Remove license group step plan:"+plan.toXml());
        return plan;
      </Source>
    </Script>
    <Transition to="Provision"/>
  </Step>
  <Step icon="Message" name="Update telephone number" posX="490" posY="258" resultVariable="plan">
    <Description>This step updates value of telephone number </Description>
    <Script>
      <Source>
        import sailpoint.object.ProvisioningPlan;
        import sailpoint.object.ProvisioningPlan.AccountRequest;
        import sailpoint.object.ProvisioningPlan.AttributeRequest;
        import java.util.List;
        import java.util.ArrayList;
        import sailpoint.object.Identity;
        import sailpoint.object.Attributes;
        import sailpoint.object.Link;
        import sailpoint.object.Application;
        import sailpoint.api.IdentityService;
        import sailpoint.api.Provisioner;
        import sailpoint.tools.GeneralException;
        import sailpoint.object.ProvisioningProject;
        import org.apache.log4j.Logger;
        import org.apache.log4j.Level;

        Logger logs = Logger.getLogger("com.ns.workflow.NS_Workflow_Leaver_final_Phase");
        logs.debug("Entering into the step leaver Telephone update");

        String appName = "Active Directory";
        Link adLink=getADAccountLink(identityName);
		Identity identityObject = context.getObjectByName(Identity.class, identityName);
        if(adLink != null){
            ProvisioningPlan updateAttributePlan = new ProvisioningPlan();
            List accountRequestList = new ArrayList();
            AccountRequest accountRequest = new AccountRequest();

			String accountDn=adLink.getAttribute("distinguishedName");
			accountRequest.setOperation(ProvisioningPlan.AccountRequest.Operation.Modify);
			accountRequest.setApplication(appName);
			accountRequest.setNativeIdentity(accountDn);
			accountRequest.add(new AttributeRequest("telephoneNumber",""));

			accountRequestList.add(accountRequest);
			updateAttributePlan.setAccountRequests(accountRequestList);
			updateAttributePlan.setIdentity(identityObject);
			updateAttributePlan.setNativeIdentity(identityName);

            return updateAttributePlan;
        }
        catch(GeneralException e){
          logs.debug("The SR AD provisioning Plan Update attribute is failed");
        }
      </Source>
    </Script>
    <Transition to="Provision"/>
  </Step>
  <Step icon="Message" name="Move AD OU to disable OU" posX="490" posY="258" resultVariable="plan">
    <Description>This step moves the SR account(Which is present in Parent Domain) to Disabled OU</Description>
    <Script>
      <Source>
        import sailpoint.object.ProvisioningPlan;
        import sailpoint.object.ProvisioningPlan.AccountRequest;
        import sailpoint.object.ProvisioningPlan.AttributeRequest;
        import sailpoint.object.ProvisioningPlan.Operation;
        import java.util.List;
        import java.util.ArrayList;
        import sailpoint.object.Identity;
        import sailpoint.object.Attributes;
        import sailpoint.object.Link;
        import sailpoint.object.Application;
        import sailpoint.object.Custom;
        import sailpoint.api.IdentityService;
        import sailpoint.api.Provisioner;
        import org.apache.log4j.Logger;
        import org.apache.log4j.Level;
        import sailpoint.tools.GeneralException;
        import sailpoint.object.ProvisioningProject;

        Logger logs = Logger.getLogger("com.ns.workflow.NS_Workflow_Leaver_final_Phase");
        logs.debug("Entering into the step Leaver OU Move");

        /*****This Step Moves account to disable OU*********/
        ProvisioningPlan ouMovePlan = new ProvisioningPlan();
        String sAMAccountName= null;
        String appName = null;
        String disabledAccountOU = null;
        String compareOU = null;
        String description = "SR master account OU is moved to disabled OU";
        Identity identityObject = context.getObjectByName(Identity.class, identityName);
        try {

            Custom cs = context.getObjectByName(Custom.class, "NS_CustomObject_Active_Directory");
            Custom cs1 = context.getObjectByName(Custom.class, "NS_CustomObject_IdentityEvent_Leaver");
            if (cs != null) {
                Map map = cs.getAttributes();
                appName = map.get("AdAppName");
				disabledAccountOU = map.get("disableOU");
                logs.debug("disabled OU Value is :: " + disableOU);
            }
            List accountRequestList = new ArrayList();
            IdentityService identityService = new IdentityService(context);
            Application appObject = context.getObjectByName(Application.class, appName);
            if(identityObject != null &amp;&amp; appObject != null ){
                List accountList = identityService.getLinks(identityObject, appObject);
                logs.debug("Link Size is........ :: " + accountList.size());
                if(accountList != null &amp;&amp; accountList.size() &gt; 0 ){
                    for (Link link: accountList) {
                        if (link != null ) {
                            sAMAccountName = link.getAttribute("sAMAccountName");
                            distinguishedName = link.getAttribute("distinguishedName");
                            logs.debug("Move the SR master account to disable OU sAMAccountName: " + sAMAccountName);
                            logs.debug("Move the SR master account OU to disable OU distinguishedName: " + distinguishedName);
                            compareOU = "CN=" + sAMAccountName + "," + disabledAccountOU;

                            if (distinguishedName != null &amp;&amp; !compareOU.equalsIgnoreCase(distinguishedName)) {

                                AccountRequest accountRequest = new AccountRequest();
                                accountRequest.setApplication(appName);

                                accountRequest.setOperation(AccountRequest.Operation.Modify);
                                accountRequest.add(new AttributeRequest("AC_NewParent", ProvisioningPlan.Operation.Set, disabledAccountOU));
                                accountRequest.setNativeIdentity(distinguishedName);

                                accountRequestList.add(accountRequest);
                            }
                        }
                    }
                    ouMovePlan.setAccountRequests(accountRequestList);
                    ouMovePlan.setIdentity(identityObject);

                    logs.debug("Move the SR master account OU to disable OU plan: " + ouMovePlan.toXml());
                }
            }
            return ouMovePlan;
        }
        catch (GeneralException e) {
            logs.debug("Move the SR master account OU to disable OU step is failed");
        }
      </Source>
    </Script>
    <Transition to="Provision"/>
  </Step>
  <Step icon="Default" name="AD Account Aggregation" posX="944" posY="167">
    <Script>
      <Source>
        import java.util.List;
        import java.util.Map;
        import java.util.ArrayList;
        import sailpoint.object.Identity;
        import sailpoint.object.Attributes;
        import sailpoint.object.Link;
        import sailpoint.object.Application;
        import sailpoint.object.Custom;
        import org.apache.log4j.Logger;
        import org.apache.log4j.Level;
        import sailpoint.tools.GeneralException;
        import sailpoint.object.ResourceObject;
        import sailpoint.object.TaskResult;
        import sailpoint.api.Aggregator;
        import sailpoint.connector.Connector;
        import sailpoint.tools.Util;
        import org.SailPoint_IIQ.Utils.AggregationHelper;
        import java.lang.*;
        import org.apache.commons.lang3.StringUtils;

        Logger logs = Logger.getLogger("com.ns.workflow.NS_Workflow_Leaver_final_Phase");
        logs.debug("Entering into the step Leaver OU Move");

        /**** This Step Account Aggregation*********/

        String commonName = null;
        String appName = null;
        String disabledAccountOU = null;
        String distinguishedName = null;
        String compareOU = null;
        String isChildDomainAccount = null;
        int domainCount=0;
        String finalCN=null;
        String SpecialCharacterComa="";
        String replaceSpecialCharecter="\\\\";

        String description = "SR master account OU is moved to disabled OU";
        Identity identityObject = context.getObjectByName(Identity.class, identityName);

        try {

            Custom cs = context.getObjectByName(Custom.class, "SR_CustomObject_Active_Directory_SRIIQ");
            if (cs != null) {
                Map map = cs.getAttributes();
                appName = map.get("AdAppName");
				disabledAccountOU = map.get("disableOU");
                logs.debug("disabled OU Value is :: " + disableOU);
            }
            List accountRequestList = new ArrayList();
            IdentityService identityServicaggr= new IdentityService(context);
            Application appObject = context.getObjectByName(Application.class, appName);
            if(identityObject!= null &amp;&amp; appObject!= null )
				{
					List accountList = identityServicaggr.getLinks(identityObject, appObject);
					logs.debug("Link Size is..... :: " +accountList.size());
				

				if(accountList != null &amp;&amp; accountList.size()&gt;0)
				{
					for(Link link:accountList)
					{
						if(link != null)
						{
							commonName = link.getAttribute("cn");
							if(StringUtils.containsIgnoreCase(commonName,SpecialCharacterComa))
							{
								commonName=commonName.replaceAll(SpecialCharacterComa,replaceSpecialCharecter);
							}

							distinguishedName = link.getAttribute("distinguishedName");
							logs.debug("Move the SR master account OU to disable OU cn: " + commonName);
							logs.debug("Move the SR master account OU to disable OU distinguishedName: " + distinguishedName);
							compareOU = "CN=" + commonName + "," + disabledAccountOU;
							logs.debug("Move the SR master account OU to disable OU compareOU: " + compareOU);
							if ( distinguishedName !=null &amp;&amp; !compareOU.equalsIgnoreCase("No")) {
								String taskAggregation = AggregationHelper.singleADAggregation(context,appName,compareOU);
								logs.debug("AD Single Account Aggregation is "+ taskAggregation);

							}else{
								logs.debug("Account not applicable to aggregate");
							}
						}
					}
				}
			}
        }catch(GeneralException e){
            logs.debug("The AD Single Account Aggregation Step failed");
        }
      </Source>
    </Script>
    <Transition to="setStatus"/>
  </Step>
  <Step action="call:refreshIdentity" icon="Task" name="Refresh Identity" posX="1028" posY="7">
    <Arg name="identityName" value="ref:identityName"/>
    <Arg name="correlateEntitlements" value="true"/>
    <Arg name="provision" value="true"/>
    <Arg name="refreshIdentityEntitlements" value="true"/>
    <Description>
      Add arguments as necessary to enable refresh features.  Typically you
      only want this to correlate roles.  Don't ask for provisioning  since that
      can result in provisioning policies that need to be presented and it's
      too late for that.  This is only to get role detection and exception
      entitlements in the cube.
    </Description>
    <Transition to="Stop"/>
  </Step>
  <Step icon="Stop" name="Stop" posX="951" posY="12"/>
</Workflow>