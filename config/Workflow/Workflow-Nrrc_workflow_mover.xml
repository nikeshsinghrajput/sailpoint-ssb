<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE Workflow PUBLIC "sailpoint.dtd" "sailpoint.dtd">
<Workflow explicitTransitions="true" libraries="Identity" name="NRRC_Workflow_Mover" type="IdentityLifecycle">
  <Variable input="true" name="trigger">
    <Description>The IdentityTrigger</Description>
  </Variable>
  <Variable input="true" name="event">
    <Description>The IdentityChangeEvent.  It can be used to build
      the provisioning plan, but does not need to be
      persisted with the case, so marked as transient.</Description>
  </Variable>
  <Variable input="true" name="identityName">
    <Description>The name of the identity.</Description>
  </Variable>
  <Variable initializer="script:(identityDisplayName != void) ? identityDisplayName : resolveDisplayName(identityName)" input="true" name="identityDisplayName">
    <Description>The displayName of the identity being updated.
      Query for this using a projection query and fall back to the name.</Description>
  </Variable>
  <Variable name="plan">
    <Description>The provisioning plan, which is built by a service method.</Description>
  </Variable>
  <Variable editable="true" name="doRefresh">
    <Description>Set to true to cause an identity refresh after the changes in the plan
      have been provisioned.  This is normally off, you might want this on
      if you want modification of identity or link attributes to result in
      an immediate re-evaluation of assigned and detected roles.</Description>
  </Variable>
  <Variable editable="true" initializer="false" name="optimisticProvisioning">
    <Description>Set to true to enable optimistic provisioning.  This will cause
      changes to the entitlements compiled from role assignments to be
      applied immediately to the identity cube rather than waiting
      for the next refresh/reaggregation after the provisioning system
      completes the request.</Description>
  </Variable>
  <Variable editable="true" initializer="true" name="foregroundProvisioning">
    <Description>Normally provisioning is done in a step that uses the &amp;quot;background&amp;quot;
      option to force the workflow to be suspend and be resumed in a
      background task thread.  This prevents the browser session from
      hanging since provision can sometimes take a long time.  For demos
      and testing it can be better to do this in the foreground so that
      provisioning will have been performed when control is returned to the
      user.  This prevents having to run the Perform Maintenance task to
      see the results of the request.</Description>
  </Variable>
  <Variable initializer="spadmin" input="true" name="fallbackApprover">
    <Description>A String that specifies the name of the Identity that will
      be assigned any approvals where the owner of the approver
      can&amp;#39;t be resolved. Example if the scheme is &amp;quot;owner&amp;quot; and the
      application doesn&amp;#39;t specify and owner.</Description>
  </Variable>
  <Variable initializer="LCM" input="true" name="source">
    <Description>String version of sailpoint.object.Source to indicate
      where the request originated.  Defaults to LCM.</Description>
  </Variable>
  <Variable initializer="false" input="true" name="trace">
    <Description>Used for debugging this workflow and when set to true trace
      will be sent to stdout.</Description>
  </Variable>
  <Variable name="project">
    <Description>ProvisioningProject which is just a compiled version of the ProvisioningPlan.</Description>
  </Variable>
  <Variable name="identityRequestId" output="true">
    <Description>The sequence id of the Identity request object which is stored in
      the name field of the identity request.</Description>
  </Variable>
  <Variable name="cart" output="true">
    <Description>This variable includes all ApprovalItems that are part of
      the request process and is updated during the AfterScript
      of the approval process by assimilating the decisions
      and comments from the Approvals copy of the ApprovalItem.</Description>
  </Variable>
  <Variable initializer="Normal" input="true" name="workItemPriority">
    <Description>The String version of a WorkItem.Priority. This variable is
      used to set the priority on all of the workitems generated
      as part of this workflow and also set on the IdentityRequest
      object.</Description>
  </Variable>
  <Variable initializer="none" input="true" name="approvalScheme"/>
  <Variable initializer="NRRC_EmailTemplate_Mover_Notification" name="emailTemplate"/>
  <Variable name="isCertificateComplete"/>
  <Variable name="certificateNames"/>
  <Variable name="certIncludedApp"/>
  <Variable name="disabNotNeedsApp"/>
  <Variable name="needsMoveOu"/>
  <Variable name="managerName"/>
  <Variable name="employeeEmail"/>
  <Variable name="terminationDate"/>
  <Variable name="wfCurrentStatus"/>
  <Variable initializer="kassi@nrrc.gov.sa" name="IAMTeam"/>
  <Variable initializer="Active Directory" name="activeDirectory"/>
  <Description>Disable all accounts when an employee leaves the company.</Description>
  <RuleLibraries>
    <Reference class="sailpoint.object.Rule" name="LCM Workflow Library"/>
    <Reference class="sailpoint.object.Rule" name="NRRC_RuleLibrary_Active_Directory"/>
  </RuleLibraries>
  <Step icon="Start" name="Start" posX="5" posY="51">
    <Script>
      <Source>
        import sailpoint.object.Identity;
        import java.util.Date;
        import org.apache.log4j.Logger;
        import sailpoint.tools.Util;

        Logger logs = Logger.getLogger("com.workflow.NRRC_Workflow_Mover");

        String terminationDate=null;
        String managerName = null;
        String managerEmail = null;
        String employeeEmail = null;
        logs.error("Entering into the step Start");

        /*  if(identityName!=null){
        Identity iden = context.getObjectByName(Identity.class, identityName);

        Identity manager = iden.getManager();
        if ( manager != null ) {
        managerName = manager.getDisplayName();
        if (Util.isNullOrEmpty(managerName)) {
        managerName = "spadmin";
        }  
        } else {
        managerName = "spadmin";
        }
        wfcontext.getWorkflowCase().put("managerName", managerName);
        logs.error("Manager Name:::::::::::::::::"+managerName);

        managerEmail = manager.getEmail();
        if(managerEmail != null){
        wfcontext.getWorkflowCase().put("managerEmail", managerEmail);
        logs.error("Manager Email:::::::::::::::::"+managerEmail);
        }
        } */
        logs.error("Exit from the step Start");		  
      </Source>
    </Script>
    <Transition to="Access Review"/>
  </Step>
  <Step icon="Task" name="Access Review" posX="103" posY="36">
    <Script>
      <Source>
        import sailpoint.object.Identity;
        import sailpoint.object.Link;
        import org.apache.log4j.Logger;
        import sailpoint.object.Custom;

        Logger logs = Logger.getLogger("com.workflow.NRRC_Workflow_Mover");
        List certExcludeApp=null;
        logs.error("certExcludeApp:::::::::");
        Set certNeedsApp=new HashSet();
        List certNames=new LinkedList();
        Set disabNotNeedsApp=new HashSet();
        Identity identity = context.getObjectByName(Identity.class, identityName);
        List links=identity.getLinks();
        Custom cs = context.getObjectByName(Custom.class, "NRRC_CustomObject_IdentityEvent_Mover");
        if (cs != null) {
        certExcludeApp =  (List) cs.get("certExcludeApp");
        }
        logs.error("certExcludeApp:::::::::"+certExcludeApp);
        if(links!=null &amp;&amp; links.size()&gt;0 &amp;&amp; certExcludeApp!=null) {
        disabNotNeedsApp.addAll(certExcludeApp);
        for(Link link:links) {
        String appName=link.getApplicationName();
        if(!certExcludeApp.contains(appName)){
        certNeedsApp.add(appName);
        }
        }
        }
        for(String app:certNeedsApp) {
        String certName= reviewAccess(identityName,app);
        certNames.add(certName);
        }
        logs.error("certNames :::::::::::::::::"+certNames);
        logs.error("certNeedsApp :::::::::::::::::"+certNeedsApp);
        wfcontext.getWorkflowCase().put("certificateNames", certNames);
        wfcontext.getWorkflowCase().put("certIncludedApp", certNeedsApp);
        wfcontext.getWorkflowCase().put("disabNotNeedsApp", disabNotNeedsApp);

      </Source>
    </Script>
    <Transition to="Certificate Completion Wait"/>
  </Step>
  <Step icon="Message" name="Certificate Completion Wait" posX="202" posY="60" wait="1">
    <Transition to="Check Certificate Status"/>
  </Step>
  <Step icon="Message" name="Check Certificate Status" posX="393" resultVariable="isCertificateComplete">
    <Script>
      <Source>
        import sailpoint.object.*;
        import org.SailPoint_IIQ.Utils.AggregationHelper;
        import sailpoint.tools.Util;
        import org.apache.log4j.Logger;
        import sailpoint.object.CertificationGroup;

        Logger logs = Logger.getLogger("com.workflow.NRRC_Workflow_Mover");
        logs.error("Entering into the Step Check Certificate Status");
        String distinguishedName = null;
        String email = null;
        boolean isCertificateComplete = false;
        if(certificateNames!=null &amp;&amp; certificateNames.size()&gt;0){
        for(String certName:certificateNames){
        logs.error("checking status of this certification :"+certName);
        Filter filter=Filter.eq("certificationGroups.name",certName);
        QueryOptions qo=new QueryOptions();
        qo.addFilter(filter);
        Iterator certificationRes = context.search(Certification.class, qo);
        if(certificationRes!=null &amp;&amp; certificationRes.hasNext()){
        while(certificationRes.hasNext()) {
        Certification cert=certificationRes.next();
        int completePercent=cert.getPercentComplete();
        if(completePercent==100)
        isCertificateComplete=true;
        else{
        isCertificateComplete=false;
        break;
        }
        }
        }else{
        isCertificateComplete=true;
        }
        }
        }

        wfcontext.setVariable("isCertificateComplete", isCertificateComplete);

        logs.error("isCertificateComplete :::::::::::::::::: "+isCertificateComplete);
        logs.error("Exit from Step Check Certificate Status");
        return isCertificateComplete;
      </Source>
    </Script>
    <Transition to="Disable Accounts" when="script:isCertificateComplete == true"/>
    <Transition to="Certificate Completion Wait" when="script:isCertificateComplete == false"/>
  </Step>
  <Step icon="Message" name="Disable Accounts" posX="542" posY="17" resultVariable="plan">
    <Description>Removes the Entitlement Except the Licenced Group and Excludes the Entitlements which are present in applicationExclusionList .</Description>
    <Script>
      <Source>
        import java.text.ParseException;
        import java.util.ArrayList;
        import java.util.HashSet;
        import java.util.Iterator;
        import java.util.LinkedList;
        import java.util.List;
        import java.util.Set;
        import org.apache.log4j.Logger;
        import sailpoint.api.SailPointContext;
        import sailpoint.object.Certification;
        import sailpoint.object.CertificationAction;
        import sailpoint.object.CertificationAction.Status;
        import sailpoint.object.CertificationEntity;
        import sailpoint.object.CertificationItem;
        import sailpoint.object.Filter;
        import sailpoint.object.Identity;
        import sailpoint.object.Link;
        import sailpoint.object.ProvisioningPlan;
        import sailpoint.object.QueryOptions;
        import sailpoint.tools.GeneralException;

        Logger logs = Logger.getLogger("com.workflow.NRRC_Workflow_Mover");


        logs.error("Entering Disable Accounts step");

        try{

        ProvisioningPlan rePlan = new ProvisioningPlan();
        List accountRequestList = new ArrayList();
        List CertificateNames=new LinkedList();
        disabNotNeedsApp.add("Active Directory");
        Identity identityObject = context.getObjectByName(Identity.class,identityName);
        if(CertificateNames!=null &amp;&amp; CertificateNames.size()&gt;0){
        for(String certName:CertificateNames){
        logs.error("checking status of this certification :"+certName);
        Filter filter=Filter.eq("certificationGroups.name",certName);
        QueryOptions qo=new QueryOptions();
        qo.addFilter(filter);
        Iterator certificationRes = context.search(Certification.class, qo);
        while(certificationRes!=null &amp;&amp; certificationRes.hasNext()) {
        Certification certObj=(Certification) certificationRes.next();
        CertificationEntity entity = certObj.getEntity(identityObject);
        List items = entity.getItems();
        boolean isAllItemRemediated=true;
        String appName=null;
        if(items!=null &amp;&amp; items.size()&gt;0) {
        for(CertificationItem certItm:items) {
        CertificationAction action = certItm.getAction();
        Status status = action.getStatus();
        System.out.println("success:::"+status);
        appName=certItm.getApplicationNames().get(0);
        if(status.compareTo(Status.Remediated)!=0) {
        isAllItemRemediated=false;
        }
        }
        }else {
        isAllItemRemediated=false;
        }
        if(isAllItemRemediated) {
        disabNotNeedsApp.add(appName);
        }
        }
        }
        }
        logs.error("disabNotNeedsApp::::::::"+disabNotNeedsApp);
        List links=identityObject.getLinks();

        if(links!=null &amp;&amp; links.size()&gt;0 &amp;&amp; certIncludedApp!=null) {
        for(Link link:links) {
        logs.error("link::::::::"+link.toXml());
        String appName=link.getApplicationName();
        if(!disabNotNeedsApp.contains(appName) &amp;&amp; !isDisabledApp(link.getApplicationName(),identityName)){
        ProvisioningPlan.AccountRequest accountRequest = new ProvisioningPlan.AccountRequest();
        accountRequest.setOperation(ProvisioningPlan.AccountRequest.Operation.Disable);
        accountRequest.setApplication(link.getApplicationName());
        accountRequest.setNativeIdentity(link.getNativeIdentity());
        accountRequestList.add(accountRequest);
        }
        }
        }
        rePlan.setAccountRequests(accountRequestList);
        rePlan.setIdentity(identityObject);
        rePlan.setNativeIdentity(identityName);
        logs.error("Plan of Disable Account :: "+rePlan.toXml());
        wfcontext.getWorkflowCase().put("wfCurrentStatus", "Disable Accounts");
        return rePlan;


        }
        catch(GeneralException e){
        logs.error("Removal of entitlements step failed");
        }
      </Source>
    </Script>
    <Transition to="Provision"/>
  </Step>
  <Step icon="Provision" name="Provision" posX="652" posY="19">
    <Arg name="identityEmailTemplate"/>
    <Arg name="enableRetryRequest"/>
    <Arg name="securityOfficerElectronicSignature"/>
    <Arg name="fallbackApprover" value="ref:fallbackApprover"/>
    <Arg name="endOnManualWorkItems"/>
    <Arg name="userEmailTemplate"/>
    <Arg name="policiesToCheck"/>
    <Arg name="workItemComments"/>
    <Arg name="identityRequestId"/>
    <Arg name="approvalSplitPoint"/>
    <Arg name="source" value="ref:source"/>
    <Arg name="identityDisplayName"/>
    <Arg name="foregroundProvisioning" value="ref:foregroundProvisioning"/>
    <Arg name="ownerElectronicSignature"/>
    <Arg name="batchRequestItemId"/>
    <Arg name="saveUnmanagedPlan_WithProjectArgument"/>
    <Arg name="splitPlans"/>
    <Arg name="doRefresh" value="ref:doRefresh"/>
    <Arg name="plan" value="ref:plan"/>
    <Arg name="flow"/>
    <Arg name="identityElectronicSignature"/>
    <Arg name="identityName" value="ref:identityName"/>
    <Arg name="approvalSet"/>
    <Arg name="violationReviewDecision"/>
    <Arg name="filterRejects"/>
    <Arg name="splitProjects"/>
    <Arg name="requireCommentsForDenial"/>
    <Arg name="requesterEmailTemplate"/>
    <Arg name="approvalEmailTemplate"/>
    <Arg name="ticketManagementApplication"/>
    <Arg name="securityOfficerName"/>
    <Arg name="approvingIdentities"/>
    <Arg name="managerEmailTemplate"/>
    <Arg name="ticketId"/>
    <Arg name="approvalScheme" value="ref:approvalScheme"/>
    <Arg name="allowRequestsWithViolations"/>
    <Arg name="workItemPriority" value="ref:workItemPriority"/>
    <Arg name="managerElectronicSignature"/>
    <Arg name="requireViolationReviewComments"/>
    <Arg name="splitApprovalSet"/>
    <Arg name="approvalMode"/>
    <Arg name="trace" value="ref:trace"/>
    <Arg name="endOnProvisioningForms"/>
    <Arg name="splitWorkItemComments"/>
    <Arg name="requireCommentsForApproval"/>
    <Arg name="notificationScheme" value="ref:notificationScheme"/>
    <Arg name="policyViolations"/>
    <Arg name="policyScheme" value="ref:policyScheme"/>
    <Arg name="setPreviousApprovalDecisions"/>
    <Arg name="optimisticProvisioning" value="ref:optimisticProvisioning"/>
    <Arg name="securityOfficerEmailTemplate"/>
    <Return name="project" to="project"/>
    <WorkflowRef>
      <Reference class="sailpoint.object.Workflow" name="LCM Provisioning"/>
    </WorkflowRef>
    <Transition to="Check If Errors"/>
  </Step>
  <Step icon="Task" name="Check If Errors" posX="746" posY="22" resultVariable="errorMessages">
    <Script>
      <Source>
        import java.util.ArrayList;
        import java.util.List;
        import org.apache.log4j.Logger;
        Logger logs = Logger.getLogger("com.workflow.NRRC_Workflow_Mover");
        logs.error("Enter into the step Check If Errors");
        List errorMessages = getRequestErrorMessages(project);
        logs.error("Error Messages : "+errorMessages);
        logs.error("Exit from the step Check If Errors");
        return  errorMessages;
      </Source>
    </Script>
    <Transition to="Stop">
      <Script>
        <Source>
          if(errorMessages != null &amp;&amp; !errorMessages.isEmpty()){
          return true;
          }
          return false;
        </Source>
      </Script>
    </Transition>
    <Transition to="Update AD Attributes" when="script:&quot;Disable Accounts&quot;.equalsIgnoreCase(wfCurrentStatus)"/>
    <Transition to="Set Status" when="script:&quot;Update AD Attributes&quot;.equalsIgnoreCase(wfCurrentStatus)"/>
  </Step>
  <Step icon="Message" name="Update AD Attributes" posX="666" posY="173" resultVariable="plan">
    <Description>This step moves the account</Description>
    <Script>
      <Source>
        import sailpoint.object.ProvisioningPlan;
        import sailpoint.object.ProvisioningPlan.AccountRequest;
        import sailpoint.object.ProvisioningPlan.AttributeRequest;
        import sailpoint.object.ProvisioningPlan.Operation;
        import java.util.List;
        import java.util.ArrayList;
        import sailpoint.object.Identity;
        import sailpoint.object.Attributes;
        import sailpoint.object.Link;
        import sailpoint.object.Application;
        import sailpoint.object.Custom;
        import sailpoint.api.IdentityService;
        import sailpoint.api.Provisioner;
        import org.apache.log4j.Logger;
        import org.apache.log4j.Level;
        import sailpoint.tools.GeneralException;
        import sailpoint.object.ProvisioningProject;

        Logger logs = Logger.getLogger("com.workflow.NRRC_Workflow_Mover");
        logs.error("Entering into the Move AD Account Ou");

        /*****This Step Moves account*********/
        String moveAccountOU = null;
        String newOu = null;
        String department=null;
        String departmentVal=null;
        String distinguishedName=null;
        Identity identityObject = context.getObjectByName(Identity.class, identityName);
        ProvisioningPlan plan = new ProvisioningPlan();
        List accountRequestList = new ArrayList();
        try {
        //   department = getDepartment(identityObject);
        department=identityObject.getAttribute("department");
        Custom cs = context.getObjectByName(Custom.class, "MapOULink");
        if (cs != null) {
        Map map = cs.getAttributes();
        logs.error("department Key  : " + department);
        moveAccountOU = map.get("EmployeeOU");
        logs.error("moveAccountOU Value is :: " + moveAccountOU);
        departmentVal = "Financial Risk Management";//cs.get(department);
        logs.error("department Value : " + departmentVal);
        }
        IdentityService identityService = new IdentityService(context);
        Application appObject = context.getObjectByName(Application.class, activeDirectory);
        if(identityObject != null &amp;&amp; appObject != null ){
        List accountList = identityService.getLinks(identityObject, appObject);
        logs.error("Link Size is........ :: " + accountList.size());
        if(accountList != null &amp;&amp; accountList.size() &gt; 0 ){
        for (Link link: accountList) {
        if (link != null ) {

        distinguishedName = link.getAttribute("distinguishedName");
        logs.error(" distinguishedName: " + distinguishedName);
        newOu = "OU=" +departmentVal + ","+ moveAccountOU;
        logs.error("MnewOu:::: " + newOu);
        if (distinguishedName != null) {

        AccountRequest accountRequest = new AccountRequest();
        accountRequest.setApplication(activeDirectory);

        accountRequest.setOperation(AccountRequest.Operation.Modify);
        if(!distinguishedName.contains(newOu))
        accountRequest.add(new AttributeRequest("AC_NewParent", ProvisioningPlan.Operation.Set, newOu));
        accountRequest.setNativeIdentity(distinguishedName);

        accountRequestList.add(accountRequest);
        }
        }
        }
        plan.setAccountRequests(accountRequestList);
        plan.setIdentity(identityObject);

        logs.error("Move OU plan: " + plan.toXml());
        }
        }
        wfcontext.getWorkflowCase().put("wfCurrentStatus", "Update AD Attributes");
        return plan;
        }
        catch (GeneralException e) {
        logs.error("Update AD Attributes failed");
        }
      </Source>
    </Script>
    <Transition to="Provision"/>
  </Step>
  <Step icon="Task" name="Set Status" posX="924" posY="23">
    <Script>
      <Source>
        import sailpoint.object.Identity;
        import org.apache.log4j.Logger;

        Logger logs = Logger.getLogger("com.workflow.NRRC_Workflow_Candidate_Mover");
        logs.error("Entering into the step Set Status");
        String setStatus=null;
        Identity identity = context.getObjectByName(Identity.class, identityName);
        String status = identity.getAttribute("nsStatus");
        logs.error("status:::::::"+status);
        if(status != null &amp;&amp; status.contains("Mover-Started")){
        setStatus="Mover-Completed";
        }
        identity.setAttribute("nsStatus", setStatus);
        context.startTransaction();
        context.saveObject(identity);
        context.commitTransaction();

        logs.error("Exit from the step Set Status");
      </Source>
    </Script>
    <Transition to="Refresh Identity"/>
  </Step>
  <Step action="call:refreshIdentity" condition="ref:doRefresh" icon="Task" name="Refresh Identity" posX="872" posY="205">
    <Arg name="identityName" value="ref:identityName"/>
    <Arg name="provision" value="true"/>
    <Arg name="correlateEntitlements" value="true"/>
    <Arg name="refreshIdentityEntitlements" value="true"/>
    <Transition to="Stop"/>
  </Step>
  <Step icon="Stop" name="Stop" posX="846" posY="135"/>
</Workflow>